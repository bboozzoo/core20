#!/bin/sh

set -e

# Ensure that console-conf is started only once the chooser detection has completed
echo "Fix console-conf systemd unit to run after snapd recovery chooser trigger detection"
for f in console-conf@.service serial-console-conf@.service; do
    p="/lib/systemd/system/$f"
    sed -i 's/After=\(.* core.start-snapd.service\)/After=\1 snapd.recovery-chooser-trigger.service/' "$p"
    # ensure sed worked
    grep "^After=.* snapd.recovery-chooser-trigger.service" "$p"
done
